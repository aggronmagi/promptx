* promptx

promptx是可定制化的交互式 cli 应用程序的库。从[[https://github.com/c-bata/go-prompt/][go-prompt]]复制了部分文件.初版实现时候也有参考 [[https://github.com/abiosoft/ishell][ishell]].

支持简单命令以及命令集.

简单命令就是所有命令初始都显示出来.

命令集是根据需要将命令拆分成不同的组,只有处在某个状态下的时候才会显示.不同命令集下不共享操作的历史记录.

所有交互式命令都使用链式调用创建.

默认 Control-C 放弃输入, Control-D 退出进程.

允许异步打印日志.例:
#+begin_src go
p := promptx.New()
log.SetOutput(p.Stdout())
#+end_src
样即使在其他gorountine使用 ~log~ 打印日志也不会影响正在输入的的选项.

zap日志需要通过 ~p.Stdout()~ 定制实现zapcore. 

** 安装
#+begin_src shell
go get github.com/aggronmagi/promptx@latest
#+end_src
** 简单命令
*** 函数风格命令（推荐用于简单命令）
使用 ~NewCommandWithFunc~ 创建带参数的命令，使用泛型方式自动解析参数：

#+begin_src go
type LoginArgs struct {
	Server  string `arg:"选择登录的游戏服务器" select:"开发服,测试服,体验服"`
	Account string `arg:"账号" check:"NotEmpty"`
}

func loginCommand() *promptx.Command {
	return promptx.NewCommandWithFunc("login", "登录游戏", func(ctx blocks.Context, arg *LoginArgs) {
		ctx.Println(arg.Account, "login success on", arg.Server)
	})
}

func main() {
	config := promptx.NewConfig()
	config.DefaultCommandGroup().AddCommand(loginCommand())
	p := config.Build()
	p.Run()
}
#+end_src

*** Commander 接口风格命令（推荐用于复杂命令）
实现 ~Commander~ 接口创建自包含的命令，参数自动从结构体字段解析：

#+begin_src go
type LoginCommand struct {
	Server  string `arg:"选择登录的游戏服务器" select:"开发服,测试服,体验服"`
	Account string `arg:"账号" check:"NotEmpty"`
}

func (c *LoginCommand) Name() string {
	return "login"
}

func (c *LoginCommand) Help() string {
	return "登录游戏"
}

func (c *LoginCommand) Exec(ctx blocks.Context) {
	ctx.Println(c.Account, "login success on", c.Server)
}

func main() {
	config := promptx.NewConfig()
	config.DefaultCommandGroup().AddCommand(promptx.NewCommand(&LoginCommand{}))
	p := config.Build()
	p.Run()
}
#+end_src

完整例子 [[./_example/demo/main.go][Common Command]]
** 新版配置 API
使用 ~NewConfig()~ 和 ~NewConfig().DefaultCommandGroup()~ 流式 API 创建命令：

#+begin_src go
func main() {
	config := promptx.NewConfig()
	
	// 在默认命令组中添加命令
	config.DefaultCommandGroup().
		AddCommand(
			promptx.NewCommand(&MyCommand1{}),
			promptx.NewCommand(&MyCommand2{}),
			loginCommand(),  // 也支持函数风格命令
		).
		CommandPrefix("!").  // 设置命令前缀
		OnNonCommand(func(ctx blocks.Context, command string) error {
			ctx.Println("non command:", command)
			return nil
		})
	
	p := config.Build()
	p.Run()
}
#+end_src

** 命令集
#+begin_src go
type LoginCommand struct {
	Server  string `arg:"选择登录的游戏服务器" select:"开发服,测试服,体验服"`
	Account string `arg:"账号" check:"NotEmpty"`
}

func (c *LoginCommand) Name() string {
	return "login"
}

func (c *LoginCommand) Help() string {
	return "登录游戏"
}

func (c *LoginCommand) Exec(ctx blocks.Context) {
	ctx.Println(c.Account, "login success")
	// 切换命令组
	promptx.SwitchCommandGroup(ctx, "area1")
}

type LogoutCommand struct{}

func (c *LogoutCommand) Name() string {
	return "logout"
}

func (c *LogoutCommand) Help() string {
	return "退出游戏"
}

func (c *LogoutCommand) Exec(ctx blocks.Context) {
	// 切换回主菜单
	promptx.SwitchCommandGroup(ctx, "")
}

func main() {
	config := promptx.NewConfig()
	
	// 默认命令组
	config.DefaultCommandGroup().
		AddCommand(promptx.NewCommand(&LoginCommand{})).
		Prompt("main >> ")
	
	// 添加其他命令组
	config.AddCommandGroup("area1").
		AddCommand(promptx.NewCommand(&LogoutCommand{})).
		Prompt("area1 >> ")

	p := config.Build()
	p.Run()
}
#+end_src
完整例子 [[./_example/commandset/main.go][Command Set]]
** API
*** 创建命令
**** 函数风格（推荐用于简单命令）
#+begin_src go
// NewCommandWithFunc 泛型命令方式，自动解析参数
func NewCommandWithFunc[ARG any](name, help string, run func(ctx blocks.Context, arg *ARG)) *Command

// NewCommandWithFuncLegacy 不带参数的命令
func NewCommandWithFuncLegacy(name, help string, run func(ctx blocks.Context)) *Command
#+end_src

**** Commander 接口风格（推荐用于复杂命令）
#+begin_src go
// Commander 接口
type Commander interface {
	Name() string
	Help() string
	Exec(ctx blocks.Context)
}

// NewCommand 创建 Commander 类型的命令
func NewCommand(custom Commander) *Command
#+end_src

**** 子命令
#+begin_src go
// SubCommands 添加子命令
func (c *Command) SubCommands(cmds ...*Command) *Command
#+end_src
*** 命令参数
参数通过结构体字段的 tag 定义。在创建命令时，参数会自动从结构体字段解析。

#+begin_src go
type LoginArgs struct {
	// 选择类型参数
	Server  string `arg:"选择登录的游戏服务器" select:"开发服,测试服,体验服"`
	// 输入类型参数，包含检查器
	Account string `arg:"账号" check:"NotEmpty"`
	// 可选参数
	Email   string `arg:"邮箱" check:"NotEmpty" optional:"true"`
}
#+end_src

**** 参数 tag 说明
- ~arg: "提示文字"~ - 参数提示信息
- ~select: "选项1,选项2,选项3"~ - 单选参数的选项列表
- ~check: "检查器名称"~ - 参数检查器（见下文）
- ~optional: "true"~ - 可选参数（默认为必填）

*** 参数检查器
内置检查器用于验证参数合法性：

#+begin_src go
// 检查非空字符串
check:"NotEmpty"
// 检查数值类型
check:"Integer"
// 检查非零数字
check:"NotZeroInteger"
// 检查自然数 (>=1)
check:"NaturalNumber"
#+end_src

也可以通过 ~RegisterChecker~ 注册自定义检查器：

#+begin_src go
promptx.RegisterChecker("MyChecker", func(value string) error {
	if len(value) < 3 {
		return fmt.Errorf("value too short")
	}
	return nil
})
#+end_src
*** 命令组管理
使用 ~Config~ 的流式 API 管理命令组：

#+begin_src go
// 创建配置
config := promptx.NewConfig()

// 配置默认命令组
config.DefaultCommandGroup().
	AddCommand(cmd1, cmd2, cmd3).
	Prompt("main >> ").
	History("./.history_main")

// 添加其他命令组
config.AddCommandGroup("area1").
	AddCommand(cmd4, cmd5).
	Prompt("area1 >> ").
	History("./.history_area1")

p := config.Build()
p.Run()
#+end_src

**** 命令组选项
命令组配置方法：

#+begin_src go
// 添加命令
func (g *CommandGroupBuilder) AddCommand(cmds ...*Command) *CommandGroupBuilder

// 设置提示符
func (g *CommandGroupBuilder) Prompt(prompt string) *CommandGroupBuilder

// 设置历史文件
func (g *CommandGroupBuilder) History(filepath string) *CommandGroupBuilder

// 执行前检查函数
func (g *CommandGroupBuilder) PreCheck(fn func(ctx blocks.Context) error) *CommandGroupBuilder

// 非命令处理函数
func (g *CommandGroupBuilder) OnNonCommand(fn func(ctx blocks.Context, command string) error) *CommandGroupBuilder

// 命令前缀设置
func (g *CommandGroupBuilder) CommandPrefix(prefix string) *CommandGroupBuilder

// 命令组切换回调
func (g *CommandGroupBuilder) OnChange(fn func(ctx blocks.Context, name string)) *CommandGroupBuilder
#+end_src

**** 切换命令组
在命令执行函数中切换命令组：

#+begin_src go
// 使用 SwitchCommandGroup 函数
promptx.SwitchCommandGroup(ctx, "area1")

// 或直接调用 ctx 的方法
ctx.(promptx.CommandGroupSwitcher).SwitchCommandGroup("area1")
#+end_src

*** Word 彩色文字
#+begin_src go
// WordDefault color text
func WordDefault(str string) *Word 
// WordBlue color text
func WordBlue(str string) *Word 
// WordBrown color text
func WordBrown(str string) *Word 
// WordCyan color text
func WordCyan(str string) *Word 
// WordGreen color text
func WordGreen(str string) *Word 
// WordPurple color text
func WordPurple(str string) *Word 
// WordRed color text
func WordRed(str string) *Word 
// WordTurquoise color text
func WordTurquoise(str string) *Word 
// WordWhite color text
func WordWhite(str string) *Word 
// WordYellow color text
func WordYellow(str string) *Word 
#+end_src
** 完整例子
[[./_example/demo/main.go][Common Command]]

[[./_example/commandset/main.go][Command Set]]

** 从[[https://github.com/c-bata/go-prompt/][go-prompt]]复制文件列表
| dir-or-files                            | source-repo | modify |
|-----------------------------------------+-------------+--------|
| internal/ debug,strings,bisect          | [[https://github.com/c-bata/go-prompt/][go-prompt]]   |        |
| output/input/terminal/completion/buffer | [[https://github.com/c-bata/go-prompt/][go-prompt]]   |        |


** 编辑快捷键
*** emacs key bind

Moving the cursor
-----------------
| ok  | key       | description                                                  |
|-----+-----------+--------------------------------------------------------------|
| [x] | Ctrl + a  | Go to the beginning of the line (Home)                       |
| [x] | Ctrl + e  | Go to the End of the line (End)                              |
| [x] | Ctrl + p  | Previous command (Up arrow)                                  |
| [x] | Ctrl + n  | Next command (Down arrow)                                    |
| [x] | Ctrl + f  | Forward one character                                        |
| [x] | Ctrl + b  | Backward one character                                       |
| [x] | Meta + B  |                                                              |
| [x] | Meta + F  |                                                              |

Editing
-------
| ok  | key      | description                                             |
|-----+----------+---------------------------------------------------------|
| [x] | Ctrl + L | Clear the Screen, similar to the clear command          |
| [x] | Ctrl + d | Delete character under the cursor                       |
| [x] | Ctrl + h | Delete character before the cursor (Backspace)          |
| [x] | Ctrl + w | Cut the Word before the cursor to the clipboard.        |
| [x] | Ctrl + k | Cut the Line after the cursor to the clipboard.         |
| [x] | Ctrl + u | Cut/delete the Line before the cursor to the clipboard. |
| [ ] | Ctrl + t | Swap the last two characters before the cursor (typo).  |
| [ ] | Esc  + t | Swap the last two words before the cursor.              |
| [ ] | ctrl + y | Paste the last thing to be cut (yank)                   |
| [ ] | ctrl + _ | Undo                                                    |
** 定制化
promptx 将很多逻辑都做成了可配置项. 查看 "gen_options_*.go"
